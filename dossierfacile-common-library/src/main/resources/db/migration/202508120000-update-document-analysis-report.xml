<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="202508120000-01" author="Nicolas Sagon">
        <dropForeignKeyConstraint baseTableName="blurry_file_analysis"
                                  constraintName="fk_file_blurry_file_analysis"/>

        <addForeignKeyConstraint baseTableName="blurry_file_analysis"
                                 baseColumnNames="file_id"
                                 constraintName="fk_file_blurry_file_analysis"
                                 referencedTableName="file"
                                 referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <modifyDataType tableName="blurry_file_analysis"
                        columnName="file_id"
                        newDataType="BIGINT"/>

        <dropNotNullConstraint tableName="blurry_file_analysis"
                               columnName="file_id"
                               columnDataType="BIGINT"/>

        <addColumn tableName="blurry_file_analysis">
            <column name="data_file_id" type="BIGINT"/>
        </addColumn>

        <update tableName="blurry_file_analysis">
            <column name="data_file_id" valueComputed="file_id"/>
            <where>data_file_id IS NULL</where>
        </update>
    </changeSet>

    <changeSet id="202508120000-02" author="Nicolas Sagon">
        <dropForeignKeyConstraint baseTableName="document_analysis_report"
                                  constraintName="fk_document_analysis_report_document"/>

        <addForeignKeyConstraint baseTableName="document_analysis_report"
                                 baseColumnNames="document_id"
                                 constraintName="fk_document_analysis_report_document"
                                 referencedTableName="document"
                                 referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <modifyDataType tableName="document_analysis_report"
                        columnName="document_id"
                        newDataType="BIGINT"/>

        <dropNotNullConstraint tableName="document_analysis_report"
                               columnName="document_id"
                               columnDataType="BIGINT"/>
    </changeSet>

    <changeSet id="202504220000-03" author="Nicolas Sagon">
        <renameColumn tableName="document_analysis_report"
                      oldColumnName="broken_rules"
                      newColumnName="failed_rules"
                      columnDataType="jsonb"/>

        <addColumn tableName="document_analysis_report">
            <column name="passed_rules" type="jsonb"/>
            <column name="inconclusive_rules" type="jsonb"/>
            <column name="created_at" type="timestamp" defaultValueDate="1970-01-01T00:00:00"/>
            <column name="data_document_id" type="BIGINT"/>
        </addColumn>

        <update tableName="document_analysis_report">
            <column name="data_document_id" valueComputed="document_id"/>
            <where>data_document_id IS NULL</where>
        </update>

    </changeSet>
</databaseChangeLog>