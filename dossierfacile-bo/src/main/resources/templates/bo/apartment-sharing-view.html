<!DOCTYPE html>
<html lang="en"
      layout:decorate="~{bo/layout-bo}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
<head>
    <title>DossierFacile</title>
    <link rel="stylesheet" href="/css/apartment-sharing-view.css"/>
    <script src="/js/partages-dossier.js" defer></script>
</head>
<body>
<div layout:fragment="content" th:remove="tag">

    <div class="row class-message-link">
        <div class="col-md-12 col-lg-12">

            <ul class="nav nav-tabs" role="tablist">

                <li class="nav-item active" role="presentation" sec:authorize="hasRole('ROLE_SUPPORT')">
                    <a class="nav-link active"
                       data-bs-toggle="tab"
                       href="#colocatio"
                       data-bs-target="#colocatio"
                       type="button"
                       role="presentation"
                       aria-controls="colocatio"
                       th:text="#{apartmentSharing}"
                    ></a>
                </li>

                <li class="nav-item" role="presentation" th:each="tenant,iter:${tenants}">
                    <a class="nav-link data-tab2"
                       th:id="'badge2' + ${tenant.id}"
                       data-bs-toggle="tab"
                       th:href="'#tenant'+${tenant.id}"
                       th:data-bs-target="'#tenant'+${tenant.id}"
                       type="button"
                       role="tab"
                       aria-controls="mon-dossier"
                       th:attr="data-name=${tenant.id}"
                       th:text="${tenant.getFullName()} ==''? 'locataire ':${tenant.getFullName()}"
                    ></a>
                </li>

                <li class="nav-item" role="presentation" th:each="tenant,iter:${tenants}">
                    <a class="nav-link chat"
                       data-bs-toggle="tab"
                       th:data-bs-target="'#tenant-message'+${tenant.id}"
                       type="button"
                       role="tab"
                       aria-controls="mon-dossier"
                       th:href="'#tenant-message'+${tenant.id}"
                       th:text="'message: '+${tenant.getFullName()}"
                       th:attrappend="data-tenant-id=${tenant.id}"
                    ></a>
                </li>

            </ul>
            <!-- Tab panes -->

            <div class="tab-content">
                <div class="tab-pane show active" id="colocatio" role="tabpanel" sec:authorize="hasRole('ROLE_SUPPORT')">
                    <div class="container">
                        <div class="medium-space-separator">
                            <div class="row">
                                <div class="">
                                    <button class="btn btn-success bo-btn deleteApartmentSharing"
                                            style="color: white;background-color: #f0ad4e;float: right;margin-right: 10px;margin-bottom: 10px;background-color: #d9534f;border-color: #d43f3a;"
                                            th:href="@{/bo/tenant/deleteApartmentSharing/} + ${tenantPrincipal.getId()}"
                                    >Supprimer la colocation
                                    </button>
                                    <a class="btn btn-success bo-btn btnPartner"
                                       style="float: left;background-color: darkcyan;border-color: var(--bs-info-bg-subtle);">
                                        Trigger a partner callback
                                    </a>
                                </div>

                            </div>
                            <div class="modal" id="triggerPart" role="dialog"
                                 tabindex="-1">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header" style="background: #f18686;padding: 10px;">
                                            <h5 class="modal-title bold">Select</h5>
                                            <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                    type="button"></button>
                                        </div>
                                        <div class="modal-body bg-body-tertiary">
                                            <form method="post"
                                                  style="margin-top: 8px;"
                                                  th:action="@{/bo/tenant/partner/}+${tenantPrincipal.getId()}"
                                                  th:object="${partnerUpdate}">
                                                <label for="action2" style="margin-left: 5px">partner:</label>
                                                <select id="action2" name="action"
                                                        style=" border-radius: 3px; padding-left: 5px !important;padding-right: 5px;"
                                                        th:field="*{partner}">
                                                    <option selected="selected" value="">-----------------</option>
                                                    <option th:each="partner:${partnersList}"
                                                            th:text="${partner.getName()}"
                                                            th:value="${partner.getId()}"></option>
                                                </select>

                                                <div class="modal-footer bg-body-tertiary"
                                                     style="padding: 5px;margin-top: 20px;">
                                                    <button class="btn btn-primary"
                                                            id="hrefPartner" name="submit"
                                                            style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                            type="submit"
                                                            value="submit">
                                                        Submit
                                                    </button>
                                                    <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                            style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                            type="button">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="modal" id="deleteTenant" role="dialog"
                                 tabindex="-1">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header" style="background: #f18686;padding: 10px;">
                                            <h5 class="modal-title bold" style="width: 80%;float: left;">Confirm
                                                delete</h5>
                                            <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                    type="button"></button>
                                        </div>
                                        <div class="modal-body bg-body-tertiary"
                                             style="text-shadow: 0 0 black;">
                                            <p>Are you sure you want delete this tenant ?</p>
                                        </div>
                                        <div class="modal-footer bg-body-tertiary" style="padding: 5px;">
                                            <a class="btn btn-primary"
                                               id="idRef"
                                               style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                               th:href="@{/bo/tenant/delete/tenant/} + ${tenantPrincipal.getId()}">Delete</a>
                                            <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                    style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                    type="button">
                                                Close
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal" id="deleteApartmentSharing" role="dialog"
                                 tabindex="-1">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header" style="background: #f18686;padding: 10px;">
                                            <h5 class="modal-title bold" style="width: 80%;float: left;">
                                                Confirmation
                                            </h5>
                                            <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                    type="button"></button>
                                        </div>
                                        <div class="modal-body bg-body-tertiary"
                                             style="text-shadow: 0 0 black;">
                                            <p>Êtes-vous sûr de vouloir supprimer ce dossier ainsi que tous ses
                                                candidats ?</p>
                                        </div>
                                        <div class="modal-footer bg-body-tertiary" style="padding: 5px;">
                                            <a class="btn btn-primary"
                                               id="idRefApt"
                                               style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                               th:href="@{/bo/tenant/deleteApartmentSharing/} + ${tenantPrincipal.getId()}">
                                                Oui
                                            </a>
                                            <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                    style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                    type="button">
                                                Annuler
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <table class="table table-striped table-bordered table-hover">
                                <tr>
                                    <td>Statut</td>
                                    <td colspan="2" th:text="${apartmentSharing.getStatus()}"></td>
                                </tr>
                                <tr>
                                    <td>Nombre de locataires</td>
                                    <td colspan="2" th:text="${apartmentSharing.getNumberOfTenants()}"></td>
                                </tr>
                                <tr>
                                    <td>Type d'application</td>
                                    <td colspan="2" th:text="${apartmentSharing.getApplicationType()}"></td>
                                </tr>

                            </table>
                            
                            <!-- Nouvelle section Partages du dossier -->
                            <div class="partages-dossier-section" th:if="${not #lists.isEmpty(activeLinks)}">
                                <h2 class="partages-title">Partages du dossier</h2>
                                <p class="partages-count">
                                    <strong>Nombre de partages</strong> : <span th:text="${#lists.size(activeLinks)}">0</span>
                                </p>
                                
                                <div class="partages-cards">
                                    <div class="partage-card" th:each="link : ${activeLinks}">
                                        <!-- Header -->
                                        <div class="partage-header">
                                            <div class="partage-header-left">
                                                <div class="partage-title-container">
                                                    <p class="partage-link-title">
                                                        <!-- Pour les liens OWNER -->
                                                        <span th:if="${link.linkType.toString() == 'OWNER'}">
                                                            Propriétaire DossierFacile : <strong th:text="${link.title ?: 'Sans titre'}">Sans titre</strong>
                                                        </span>
                                                        <!-- Pour les liens PARTNER -->
                                                        <span th:if="${link.linkType.toString() == 'PARTNER'}">
                                                            Partenaire : <strong th:text="${link.partnerName ?: 'Inconnu'}">Partenaire</strong>
                                                        </span>
                                                        <!-- Pour les autres types de liens -->
                                                        <span th:if="${link.linkType.toString() == 'MAIL' or link.linkType.toString() == 'LINK'}">
                                                            <span th:text="${link.linkType.toString() == 'MAIL' ? 'Mail : ' : 'Titre du lien : '}">Titre du lien : </span>
                                                            <strong th:text="${link.title ?: 'Sans titre'}">Sans titre</strong>
                                                        </span>
                                                    </p>
                                                </div>
                                                <!-- Masquer l'URL pour les liens PARTNER et OWNER -->
                                                <div class="partage-url-container" th:if="${link.linkType.toString() == 'MAIL' or link.linkType.toString() == 'LINK'}">
                                                    <p class="partage-url">
                                                        Lien : <a th:href="${link.fullUrl}" target="_blank" rel="noopener noreferrer" class="partage-url-link" th:text="${link.fullUrl}">URL</a>
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="partage-header-right">
                                                <div class="partage-status-container">
                                                    <span class="badge-status" th:classappend="${link.disabled ? 'badge-pause' : 'badge-actif'}" 
                                                          th:text="${link.disabled ? 'PAUSE' : 'ACTIF'}">ACTIF</span>
                                                </div>
                                                <div class="partage-actions-buttons">
                                                    <!-- Boutons spécifiques aux liens LINK et MAIL -->
                                                    <span th:if="${link.linkType.toString() == 'MAIL' or link.linkType.toString() == 'LINK'}">
                                                        <button type="button" class="btn btn-outline-secondary btn-sm btn-copy-link" 
                                                                th:attr="data-url=${link.fullUrl}">
                                                            Copier le lien
                                                        </button>
                                                        <form th:action="@{/bo/colocation/{id}/apartmentSharingLinks/{link_id}(id=${apartmentSharing.id},link_id=${link.id})}" 
                                                              th:method="put" style="display: inline;">
                                                            <input type="hidden" name="enabled" th:value="${link.disabled}" />
                                                            <button type="submit" class="btn btn-outline-secondary btn-sm"
                                                                    th:text="${link.disabled ? 'Réactiver le lien' : 'Mettre en pause le lien'}">
                                                                Mettre en pause le lien
                                                            </button>
                                                        </form>
                                                    </span>
                                                    <!-- Bouton Supprimer (commun à tous les types) -->
                                                    <form th:action="@{/bo/colocation/{id}/apartmentSharingLinks/{link_id}(id=${apartmentSharing.id},link_id=${link.id})}" 
                                                          th:method="delete" 
                                                          style="display: inline;"
                                                          onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce lien ?');">
                                                        <button type="submit" class="btn btn-outline-secondary btn-sm">
                                                            Supprimer le lien
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Body -->
                                        <div class="partage-body">
                                            <div class="partage-content">
                                                <!-- Section Partage -->
                                                <div class="partage-info-section">
                                                    <div class="partage-info-row">
                                                        <div class="partage-info-label">Partage :</div>
                                                        <div class="partage-info-values">
                                                            <!-- Affichage pour les liens de type MAIL -->
                                                            <span th:if="${link.linkType.toString() == 'MAIL'}">
                                                                <strong>Par mail :</strong> <span th:text="${link.email}">email</span>
                                                            </span>
                                                            <!-- Affichage pour les liens partenaires -->
                                                            <span th:if="${link.linkType.toString() == 'PARTNER'}">
                                                                <strong>Partenaire :</strong> <span th:text="${link.partnerName}">Partenaire</span>
                                                            </span>
                                                            <!-- Affichage pour les liens propriétaires -->
                                                            <span th:if="${link.linkType.toString() == 'OWNER'}">
                                                                <strong>Propriétaire DossierFacile</strong>
                                                            </span>
                                                            <!-- Affichage pour les liens simples -->
                                                            <span th:if="${link.linkType.toString() == 'LINK'}">
                                                                <strong>Par lien</strong>
                                                            </span>
                                                            <span th:if="${link.lastSentDatetime != null}">
                                                                <strong>Dernier envoi :</strong> 
                                                                <span th:text="${#temporals.format(link.lastSentDatetime, 'dd MMMM yyyy à HH''h''mm', new java.util.Locale('fr'))}">Date</span>
                                                            </span>
                                                            <!-- Pour les liens non-PARTNER et non-OWNER : afficher Créé le et Expire le -->
                                                            <span th:if="${link.linkType.toString() != 'PARTNER' and link.linkType.toString() != 'OWNER' and link.creationDate != null}">
                                                                <strong>Créé le :</strong> 
                                                                <span th:text="${#temporals.format(link.creationDate, 'dd MMMM yyyy', new java.util.Locale('fr'))}">Date</span>
                                                            </span>
                                                            <span th:if="${link.linkType.toString() != 'PARTNER' and link.linkType.toString() != 'OWNER' and link.expirationDate != null}">
                                                                <strong>Expire le :</strong> 
                                                                <span th:text="${#temporals.format(link.expirationDate, 'dd MMMM yyyy', new java.util.Locale('fr'))}">Date</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Créé par (sur une ligne séparée pour non-PARTNER et non-OWNER) -->
                                                    <div class="partage-info-row" th:if="${link.linkType.toString() != 'PARTNER' and link.linkType.toString() != 'OWNER' and link.createdByName != null}">
                                                        <div class="partage-info-label"></div>
                                                        <div class="partage-info-values">
                                                            <span>
                                                                <strong>Créé par :</strong> <span th:text="${link.createdByName}">Créateur</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Section Durée (pour PARTNER et OWNER) -->
                                                <div th:if="${link.linkType.toString() == 'PARTNER' or link.linkType.toString() == 'OWNER'}">
                                                    <div class="partage-separator"></div>
                                                    
                                                    <div class="partage-info-section">
                                                        <div class="partage-info-row">
                                                            <div class="partage-info-label">Durée :</div>
                                                            <div class="partage-info-values">
                                                                <span th:if="${link.creationDate != null}">
                                                                    <strong>Créé le :</strong> 
                                                                    <span th:text="${#temporals.format(link.creationDate, 'dd MMMM yyyy', new java.util.Locale('fr'))}">Date</span>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="partage-separator"></div>
                                                
                                                <!-- Section Dossier -->
                                                <div class="partage-info-section">
                                                    <div class="partage-info-row">
                                                        <div class="partage-info-label">Dossier :</div>
                                                        <div class="partage-info-values">
                                                            <span class="partage-data-type" th:text="${link.fullData ? 'Avec justificatifs' : 'Sans justificatifs'}">
                                                                Sans justificatifs
                                                            </span>
                                                            <span>
                                                                <strong>Nombre de consultations :</strong> <span th:text="${link.nbVisits}">0</span>
                                                            </span>
                                                            <span th:if="${link.firstVisit != null}">
                                                                <strong>Première consultation :</strong> 
                                                                <span th:text="${#temporals.format(link.firstVisit, 'dd MMMM yyyy', new java.util.Locale('fr'))}">Date</span>
                                                            </span>
                                                            <span th:if="${link.lastVisit != null}">
                                                                <strong>Dernière consultation :</strong> 
                                                                <span th:text="${#temporals.format(link.lastVisit, 'dd MMMM yyyy à HH:mm', new java.util.Locale('fr'))}">Date</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Téléchargements du dossier (pour PARTNER et OWNER) -->
                                                    <div class="partage-info-row" th:if="${link.linkType.toString() == 'PARTNER' or link.linkType.toString() == 'OWNER'}">
                                                        <div class="partage-info-label"></div>
                                                        <div class="partage-info-values">
                                                            <span>
                                                                <strong>Téléchargements du dossier :</strong> <span th:text="${link.nbDownloads}">0</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Section Liste des accès -->
                                                <div class="access-logs-section" th:if="${not #lists.isEmpty(link.accessLogs)}">
                                                    <div class="access-logs-separator"></div>
                                                    
                                                    <div class="access-logs-header">
                                                        <p class="access-logs-title">Liste des accès</p>
                                                        <button 
                                                            class="btn btn-voir-plus" 
                                                            type="button" 
                                                            data-bs-toggle="collapse" 
                                                            th:attr="data-bs-target='#access-logs-' + ${link.id}"
                                                            aria-expanded="false">
                                                            <span class="label-collapsed">Voir plus</span>
                                                            <span class="label-expanded">Voir moins</span>
                                                        </button>
                                                    </div>
                                                    
                                                    <div class="collapse access-logs-content" th:id="'access-logs-' + ${link.id}">
                                                        <ul class="access-logs-list">
                                                            <li th:each="log : ${link.accessLogs}">
                                                                <span th:text="${#temporals.format(log.creationDate, 'dd MMMM yyyy à HH:mm', new java.util.Locale('fr'))}">Date</span>
                                                                <span th:if="${log.ipAddress != null}"> - IP : <span th:text="${log.ipAddress}">IP</span></span>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                    
                                                    <div class="access-logs-separator"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Fin section Partages du dossier -->
                            
                            <!-- Section Partages supprimés -->
                            <div class="deleted-shares-section" 
                                 th:with="
                                   deletedLinksFiltered=${deletedLinks.?[linkType.toString() == 'LINK']},
                                   deletedMails=${deletedLinks.?[linkType.toString() == 'MAIL']},
                                   deletedOwners=${deletedLinks.?[linkType.toString() == 'OWNER']},
                                   deletedPartners=${deletedLinks.?[linkType.toString() == 'PARTNER']}">
                                
                                <h2 class="deleted-shares-title">Partages supprimés</h2>
                                
                                <div class="deleted-shares-categories">
                                    <!-- Catégorie : Partages par lien (LINK) - Toujours affichée -->
                                    <div class="deleted-category">
                                        <div class="deleted-category-header">
                                            <p class="deleted-category-title">
                                                Partages par lien (<span th:text="${#lists.size(deletedLinksFiltered)}">0</span>)
                                            </p>
                                            <!-- Bouton visible uniquement si la catégorie n'est pas vide -->
                                            <button class="btn btn-voir-plus" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#deleted-links"
                                                    aria-expanded="false"
                                                    th:if="${!#lists.isEmpty(deletedLinksFiltered)}">
                                                <span class="label-collapsed">Voir plus</span>
                                                <span class="label-expanded">Voir moins</span>
                                            </button>
                                        </div>
                                        <div class="collapse deleted-category-content" id="deleted-links" th:if="${!#lists.isEmpty(deletedLinksFiltered)}">
                                            <ul class="deleted-links-list">
                                                <li th:each="link : ${deletedLinksFiltered}">
                                                    <span th:text="${link.title ?: 'Sans titre'}">Titre</span> - 
                                                    <strong>Supprimé le : </strong>
                                                    <span th:text="${#temporals.format(link.expirationDate, 'dd MMMM yyyy - HH:mm', new java.util.Locale('fr'))}">Date</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Catégorie : Partages par email (MAIL) - Toujours affichée -->
                                    <div class="deleted-category">
                                        <div class="deleted-category-header">
                                            <p class="deleted-category-title">
                                                Partages par email (<span th:text="${#lists.size(deletedMails)}">0</span>)
                                            </p>
                                            <button class="btn btn-voir-plus" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#deleted-mails"
                                                    aria-expanded="false"
                                                    th:if="${!#lists.isEmpty(deletedMails)}">
                                                <span class="label-collapsed">Voir plus</span>
                                                <span class="label-expanded">Voir moins</span>
                                            </button>
                                        </div>
                                        <div class="collapse deleted-category-content" id="deleted-mails" th:if="${!#lists.isEmpty(deletedMails)}">
                                            <ul class="deleted-links-list">
                                                <li th:each="link : ${deletedMails}">
                                                    <span th:text="${link.title ?: 'Sans titre'}">Titre</span> - 
                                                    <strong>Supprimé le : </strong>
                                                    <span th:text="${#temporals.format(link.expirationDate, 'dd MMMM yyyy - HH:mm', new java.util.Locale('fr'))}">Date</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Catégorie : Propriétaires DossierFacile (OWNER) - Toujours affichée -->
                                    <div class="deleted-category">
                                        <div class="deleted-category-header">
                                            <p class="deleted-category-title">
                                                Propriétaires DossierFacile (<span th:text="${#lists.size(deletedOwners)}">0</span>)
                                            </p>
                                            <button class="btn btn-voir-plus" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#deleted-owners"
                                                    aria-expanded="false"
                                                    th:if="${!#lists.isEmpty(deletedOwners)}">
                                                <span class="label-collapsed">Voir plus</span>
                                                <span class="label-expanded">Voir moins</span>
                                            </button>
                                        </div>
                                        <div class="collapse deleted-category-content" id="deleted-owners" th:if="${!#lists.isEmpty(deletedOwners)}">
                                            <ul class="deleted-links-list">
                                                <li th:each="link : ${deletedOwners}">
                                                    <span th:text="${link.title ?: 'Sans titre'}">Titre</span> - 
                                                    <strong>Supprimé le : </strong>
                                                    <span th:text="${#temporals.format(link.expirationDate, 'dd MMMM yyyy - HH:mm', new java.util.Locale('fr'))}">Date</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Catégorie : Partenaires (PARTNER) - Toujours affichée -->
                                    <div class="deleted-category">
                                        <div class="deleted-category-header">
                                            <p class="deleted-category-title">
                                                Partenaires (<span th:text="${#lists.size(deletedPartners)}">0</span>)
                                            </p>
                                            <button class="btn btn-voir-plus" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#deleted-partners"
                                                    aria-expanded="false"
                                                    th:if="${!#lists.isEmpty(deletedPartners)}">
                                                <span class="label-collapsed">Voir plus</span>
                                                <span class="label-expanded">Voir moins</span>
                                            </button>
                                        </div>
                                        <div class="collapse deleted-category-content" id="deleted-partners" th:if="${!#lists.isEmpty(deletedPartners)}">
                                            <ul class="deleted-links-list">
                                                <li th:each="link : ${deletedPartners}">
                                                    <span th:text="${link.partnerName ?: 'Sans nom'}">Partenaire</span> - 
                                                    <strong>Supprimé le : </strong>
                                                    <span th:text="${#temporals.format(link.expirationDate, 'dd MMMM yyyy - HH:mm', new java.util.Locale('fr'))}">Date</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Fin section Partages supprimés -->
                            
                            <h2>Liste des liens de partage:</h2>
                            <table class="table table-striped table-bordered table-hover">
                                <tr>
                                    <th>Type</th>
                                    <th>Accès</th>
                                    <th>Lien</th>
                                    <th>Expire le</th>
                                    <th>Action</th>
                                </tr>
                                <tr th:each="link : ${apartmentSharing.apartmentSharingLinks}" th:if="${link.linkType.toString() != 'MAIL'}">
                                    <td th:text="${link.linkType}"></td>
                                    <td th:text="${link.fullData ? 'full' : 'restricted'}"></td>
                                    <td>
                                        <a
                                            target="_blank"
                                            th:attr="href=${tenantBaseUrl + (link.fullData ? '/file/' : '/public-file/') + link.token}"
                                            th:text="${link.token}"></a>
                                    </td>
                                    <td th:text="${link.expirationDate}"></td>
                                    <td>
                                        <form th:action="@{/bo/colocation/{id}/tokens/{token}(id=${apartmentSharing.id},token=${link.token})}" th:method="post">
                                            <button class="btn btn-outline-danger btn-modal-confirm-before-submit" type="button">Régénérer</button>
                                            <div class="modal" role="dialog" tabindex="-1">
                                                <div class="modal-dialog" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-body">Voulez-vous régénérer ce token ?</div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                            <button type="submit" class="btn btn-primary">Valider</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </td>
                                </tr>
                            </table>
                            <h2>Liste des liens envoyés:</h2>
                            <table class="table table-striped table-bordered table-hover">
                                <tr>
                                    <th>Type</th>
                                    <th>Email</th>
                                    <th>Token</th>
                                    <th>Action</th>
                                </tr>
                                <tr th:each="link : ${apartmentSharing.apartmentSharingLinks}" th:if="${link.linkType.toString() == 'MAIL'}">
                                    <td th:text="${link.linkType}"></td>
                                    <td th:text="${link.email}"></td>
                                    <td th:text="${link.token}"></td>
                                    <td>
                                        <form th:action="@{/bo/colocation/{id}/apartmentSharingLinks/{link_id}(id=${apartmentSharing.id},link_id=${link.id})}"
                                              th:method="delete">
                                            <button class="btn btn-outline-danger btn-modal-confirm-before-submit"
                                                    type="button">
                                                Supprimer
                                            </button>
                                            <div class="modal" role="dialog" tabindex="-1">
                                                <div class="modal-dialog" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-body">
                                                            <div class="modal-body">
                                                                Voulez-vous supprimer le lien?
                                                            </div>

                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary"
                                                                        data-bs-dismiss="modal">Annuler
                                                                </button>
                                                                <button class="btn  btn-primary " type="submit">
                                                                    Valider
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane data-tab2" role="tabpanel"
                     th:each="tenant,iter: ${tenants}" th:id="'tenant'+${tenant.id}">
                    <div class="container">
                        <div class="medium-space-separator">
                            <div class="row">
                                <div class="col-md-5">
                                    <form
                                            sec:authorize="hasRole('ROLE_SUPPORT')"
                                            class="form-inline btn-validate-form"
                                            style="float: left; margin-right: 10px;"
                                            th:action="@{/bo/tenant/} + ${tenant.getId()} + '/validate'"
                                            th:attr="data-id=${tenant.getId()},data-idApt=${tenant.getApartmentSharing().getId()}"
                                            th:id="'form-validated' + ${tenant.getId()}"
                                            th:method="post">
                                        <button class="btn btn-success bo-btn" name="action" type="submit"
                                                value="delete">
                                            Valider le dossier
                                        </button>
                                    </form>
                                    <form
                                            sec:authorize="hasRole('ROLE_SUPPORT')"
                                            class="form-inline btn-denied-form"
                                            style="float: left; margin-right: 10px;"
                                            th:action="@{/bo/tenant/} + ${tenant.getId()} + '/decline'"
                                            th:attr="data-id=${tenant.getId()},data-idApt=${tenant.getApartmentSharing().getId()}"
                                            th:id="'form-denied' + ${tenant.getId()}"
                                            th:method="post">
                                        <button class="btn btn-danger bo-btn" name="action" type="submit">
                                            Refuser le dossier
                                        </button>
                                    </form>

                                    <a class="btn btn-success bo-btn" data-bs-toggle="modal"
                                       style="background-color: darkcyan;"
                                       th:data-bs-target="'#target'+${tenant.getId()}">Logs</a>

                                </div>
                                <div class="col-md-7">

                                    <a class="btn btn-success bo-btn"
                                       style="float: right;"
                                       th:href="@{/bo/tenant/} + ${tenant.getId()} + '/processFile'">
                                        Traiter les documents
                                    </a>
                                    <div th:if="${ tenant.getTenantType().toString() == 'JOIN' }">
                                        <a class="btn btn-warning bo-btn"
                                           style="margin-right: 10px;float: right"
                                           th:attrappend="data-id=${tenant.getId()}"
                                           th:href="@{/bo/tenant/setAsTenantCreate/} + ${tenant.getId()}"
                                           th:text="'Fixer comme locataire principal'"
                                        ></a>
                                    </div>
                                    <div th:if="${ tenant.getTenantType().toString() != 'CREATE'}">
                                        <a class="btn btn-danger bo-btn btn-deleteCotenant"
                                           style="margin-right: 10px;float: right"
                                           th:attrappend="data-id=${tenant.getId()}"
                                           th:href="@{/bo/tenant/deleteCoTenant/} + ${tenant.getId()}"
                                           th:text="'Supprimer le colocataire'"
                                        ></a>
                                    </div>
                                </div>

                                <div aria-hidden="true" aria-labelledby="exampleModalScrollableTitle" class="modal fade"
                                     role="dialog"
                                     tabindex="-1" th:id="'target'+${tenant.getId()}">
                                    <div class="modal-dialog modal-dialog-scrollable" role="document"
                                         style="--bs-modal-width: 600px">
                                        <div class="modal-content">
                                            <div class="modal-header" style="background: cadetblue;">
                                                <h3 class="modal-title" id="exampleModalScrollableTitle"
                                                    style="text-align: -webkit-center;"
                                                    th:text="'Logs: ' + ${tenant.getFullName()}"></h3>
                                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                        type="button"></button>
                                            </div>
                                            <div class="modal-body bg-body-tertiary"
                                                 style="max-height: 80vh;overflow-y: auto;height: auto">
                                                <div class="bg-warning-subtle"
                                                     style="display: grid; padding: 7px;margin-bottom: 10px;"
                                                     th:each="log: ${logser.getLogByTenantId(tenant.getId())}">
                                                    <div style="font-weight: bold;" th:text="${log.getTitle()}"></div>
                                                    <span class="bold" style="font-size: 14px;" th:if="${!log.getSubtitle().isEmpty()}" th:text="${log.getSubtitle()}"></span>
                                                    <span
                                                            th:text="'date: ' + ${log.getCreationDateTime().getYear()} + '-' + ${log.getCreationDateTime().getMonthValue()} + '-' + ${log.getCreationDateTime().getDayOfMonth()} + ' ' + ${log.getCreationDateTime().getHour()} + ':' + ${log.getCreationDateTime().getMinute()} + ':' + ${log.getCreationDateTime().getSecond()}">
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="modal-footer bg-body-tertiary">
                                                <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                        style="font-size: initial;color: white;background-color: #0069d9;"
                                                        type="button">
                                                    Close
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal" role="dialog" tabindex="-1"
                                     th:id="'deleteCotenant'+${tenant.getId()}">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content bg-info-subtle">
                                            <div class="modal-header" style="padding: 10px;">
                                                <h5 class="modal-title bold" style="width: 80%;float: left;">
                                                    Confirmation
                                                </h5>
                                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                        type="button"></button>
                                            </div>
                                            <div class="modal-body bg-body-tertiary"
                                                 style="text-shadow: 0 0 black;">
                                                <p>
                                                    Êtes-vous sûr de vouloir supprimer le dossier de
                                                    <span th:text="${tenant.getFullName()}"></span> ?
                                                </p>
                                            </div>
                                            <div class="modal-footer bg-body-tertiary" style="padding: 5px;">
                                                <a class="btn btn-primary"
                                                   style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                   th:href="@{/bo/tenant/deleteCoTenant/} + ${tenant.getId()}"
                                                   th:id="'deleteRefCo' + ${tenant.getId()}">
                                                    Oui
                                                </a>
                                                <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                        style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                        type="button">
                                                    Annuler
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row" style="margin-top: 0.5em">
                                <div class="col-md-10">
                                    <a class="btn btn-warning bo-btn" data-bs-toggle="modal"
                                       th:data-bs-target="'#add-comment-'+${tenant.getId()}">
                                        <span th:text="${T(org.apache.commons.lang3.StringUtils).isBlank(tenant.getOperatorComment())} ? 'Ajouter un commentaire' : 'Editer le commentaire'"></span>
                                    </a>
                                </div>
                                <div class="modal fade" th:id="'add-comment-' + ${tenant.getId()}" role="dialog"
                                     tabindex="-1">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title bold" style="width: 80%;float: left;">
                                                    Précisions concernant le traitement du dossier
                                                </h5>
                                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                        type="button"></button>
                                            </div>

                                            <form method="post" th:action="@{/bo/tenant/__${tenant.getId()}__/comment}">
                                                <div class="modal-body">
                                                    <textarea id="comment" name="comment" class="input" rows="6"
                                                              type="text"
                                                              th:text="${tenant.getOperatorComment()}"></textarea>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="submit" class="btn btn-info btn-save"
                                                            style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;">
                                                        Sauvegarder
                                                    </button>
                                                    <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                            style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                            type="button">
                                                        Annuler
                                                    </button>
                                                </div>
                                            </form>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">

                            <table class="table table-striped table-bordered table-hover"
                                   th:with="partners=${partnerListByTenant.getNamesOfPartnerByTenantId(tenant.getId())}">
                                <tr th:if="${tenant.getOperatorComment() != null && !tenant.getOperatorComment().isEmpty()}">
                                    <td style="width: 25%">⚠️ Commentaire opérateur</td>
                                    <td th:text="${tenant.getOperatorComment()}"></td>
                                </tr>
                                <tr th:if="${!partners.isEmpty()}">
                                    <td>Partenaire(s)</td>
                                    <td>
                                        <ul>
                                            <li
                                                    th:each="item : ${partners}"
                                                    th:text="${item}"
                                            >
                                            </li>
                                        </ul>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <div class="table-responsive">

                            <table class="table table-striped table-bordered table-hover">
                                <tr>
                                    <td style="width: 25%">Tenant Id</td>
                                    <td th:text="${tenant.getId()}"></td>
                                </tr>
                                <tr>
                                    <td>Prénom</td>
                                    <td th:text="${tenant.getFirstName()}"></td>
                                </tr>
                                <tr>
                                    <td>Nom</td>
                                    <td th:text="${tenant.getLastName()}"></td>
                                </tr>
                                <tr>
                                    <td>Nom d'usage</td>
                                    <td th:text="${tenant.getPreferredName()}"></td>
                                </tr>
                                <tr>
                                    <td>Email</td>
                                    <td>
                                        <span th:if="${ tenant.getFranceConnect() == true }"><img
                                                src="/assets/images/franceconnect-icon.png" height="22px"
                                                alt="isFC"/></span>
                                        <span th:text="${tenant.getEmail()}"></span>
                                        <span th:with="verified=${tenantService.hasVerifiedEmailIfExistsInKeycloak(tenant)}">
                                            <span class="fa"
                                                  th:if="${verified != null}"
                                                  th:classappend="${verified} ? 'fa-check text-success' : 'fa-times text-danger'"
                                                  th:text="${verified} ? ' Vérifié' : ' Non vérifié'">
                                            </span>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Code postal</td>
                                    <td>
                                        <span th:text="${tenant.getZipCode()}"></span>
                                        <span th:if="${tenant.abroad == true}">À l'étranger</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Type de compte</td>
                                    <td th:text="${tenant.getTenantType().toString() == 'CREATE' ?
                                        'Utilisateur principal (initiateur du dossier)' :
                                        'Utilisateur invité (pas initiateur du dossier)'}">
                                    </td>
                                </tr>
                                <tr>
                                    <td>Statut du dossier</td>
                                    <td th:text="${tenant.getStatus()}"></td>
                                </tr>
                            </table>
                        </div>

                        <div class="table-responsive" th:unless="${tenant.getGuarantors().isEmpty()}">

                            <table class="table table-striped table-bordered table-hover">
                                <tr>
                                    <td>Type de garant</td>
                                    <td>Prénom</td>
                                    <td>Nom</td>
                                    <td>Nom de la personne morale</td>
                                </tr>
                                <tr th:each="guarantor : ${tenant.getGuarantors()}">
                                    <td th:text="${guarantor.getTypeGuarantor()}"></td>
                                    <td th:text="${guarantor.getFirstName()}"></td>
                                    <td th:text="${guarantor.getLastName()}"></td>
                                    <td th:text="${guarantor.getLegalPersonName()}"></td>
                                </tr>
                            </table>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover">
                                <tr>
                                    <td style="width: 20%">Déclaration sur l'honneur</td>
                                    <td th:text="${tenant.getHonorDeclaration()}"
                                        th:style="${tenant.getHonorDeclaration() == false ? 'color: red;' : ''}"></td>
                                </tr>
                                <tr>
                                    <td>Mot du locataire</td>
                                    <td th:text="${tenant.getClarification()}"></td>
                                </tr>
                            </table>
                        </div>

                        <div class="medium-space-separator" id="update-status">
                            <div class="card panel-primary mb-3"
                                 th:each="document,iter : ${tenantService.getAllDocumentCategories(tenant)}">

                                <div class="card-header">

                                    <div class="card-title" th:if="${document.getId() == null}">
                                        <span>Category:
                                            <span
                                                    th:text="${document.getDocumentCategory().name()}">
                                            </span>
                                        </span>
                                    </div>

                                    <div class="card-title"
                                         th:if="${document.getId() != null} and ${document.getWatermarkFile() == null}">
                                        <span>Category:
                                            <span
                                                    th:text="${document.getDocumentCategory().name()}">
                                            </span>
                                        </span>
                                        <span> Subcategory:
                                            <span
                                                    th:text="${document.getDocumentSubCategory().name()}">
                                            </span>
                                        </span>

                                        <a class="btn btn-sm btn-warning btn-right-pull pull-right deleteButton badge bg-warning text-dark"
                                           th:attrappend="data-id=${document.id}"
                                           th:href="@{/bo/tenant/delete/document/} + ${document.getId()}">
                                            DELETE
                                        </a>

                                        <span class="btn-right-pull badge bg-success pull-right"
                                              style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='VALIDATED'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>
                                        <span class="btn-right-pull badge bg-danger pull-right" style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='DECLINED'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>
                                        <span class="btn-right-pull badge bg-info pull-right" style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='TO_PROCESS'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>

                                        <div class="container" style="margin-top: 5px; padding-left: 0">
                                            <div class="container" style="margin-top: 5px; padding-left: 0">
                                                PDF status:
                                                <span th:if="${document.getLastModifiedDate() == null || document.getLastModifiedDate().plusMinutes(30).isBefore(now)}"
                                                      style="color:white; background-color: red; font-weight: bolder">
                                                        FAILED
                                                </span>
                                                <span th:unless="${document.getLastModifiedDate() == null || document.getLastModifiedDate().plusMinutes(30).isBefore(now)}"
                                                      style="color:white; background-color: orange; font-weight: bolder">
                                                        IN_PROGRESS
                                                </span>

                                                <a class="btn btn-light btn-sm ms-2"
                                                   th:href="@{/bo/regeneratePdfDocument/} + ${document.getId()}">Update
                                                    PDF</a>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card-title"
                                         th:if="${document.getId() != null} and ${document.getWatermarkFile() != null}">
                                        <span>Category:
                                            <span
                                                    th:text="${document.getDocumentCategory().name()}">
                                            </span>
                                        </span>
                                        <span> Subcategory:
                                            <span
                                                    th:text="${document.getDocumentSubCategory().name()}">
                                            </span>
                                        </span>

                                        <a class="btn btn-sm btn-warning btn-right-pull pull-right deleteButton badge bg-warning text-dark"
                                           th:attrappend="data-id=${document.id}"

                                           th:href="@{/bo/tenant/delete/document/} + ${document.getId()}"
                                        >DELETE
                                        </a>

                                        <span class="btn-right-pull badge bg-success pull-right"
                                              style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='VALIDATED'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>
                                        <span class="btn-right-pull badge bg-danger pull-right" style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='DECLINED'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>
                                        <span class="btn-right-pull badge bg-info pull-right" style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='TO_PROCESS'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>

                                        <div class="container" style="display: flex; margin-top: 5px">
                                            <form method="get" style="margin-top: 8px;"
                                                  th:action="@{/bo/tenant/status/} + ${document.getId()}"
                                                  th:id="'form-change-document-status' + ${document.getId()}"
                                                  th:object="${messageDTO}">
                                                <label for="action"
                                                       style="FONT-SIZE:revert;color: white;">Change status:</label>
                                                <select id="action" name="action"
                                                        style="font-size: smaller;"
                                                        th:attr="document-id=${document.getId()}"
                                                        th:class="'select-change-document-status'"
                                                        th:field="*{message}">
                                                    <option value="">-- SELECT --</option>
                                                    <option th:value="DECLINED">DECLINED</option>
                                                    <option th:value="TO_PROCESS">TO_PROCESS</option>
                                                    <option th:value="VALIDATED">VALIDATED</option>
                                                </select>
                                            </form>

                                            <a class="btn btn-light btn-sm ms-2"
                                               th:href="@{/bo/regeneratePdfDocument/} + ${document.getId()}">Update
                                                Document PDF</a>

                                            <a class="btn btn-light btn-sm ms-2"
                                               th:href="${'/documents/'+ document.getName()}" target="_blank">See
                                                Document PDF</a>
                                        </div>
                                    </div>

                                </div>

                                <div class="card-body" style="text-align: -webkit-center;background: #f0be4e"
                                     th:if="${document.getId() == null}">
                                    <div style="font-weight: bold;">ABSENT</div>
                                </div>

                                <div class="card-body" th:if="${document.getId() != null}">
                                    <div th:if="${document.getMonthlySum()!=null}">
                                        <span th:text="${'Montly sum: '+document.getMonthlySum()}"></span>
                                    </div>
                                    <div th:if="${document.getCustomText()!=null}">
                                        <span th:text="${'Custom text: '+document.getCustomText()}"></span>
                                    </div>
                                    <ul>
                                        <li style="margin-top: 5px"
                                            th:each="file : ${filesByDocument.get(document.getId())}">
                                            <a target="_blank" rel="noopener"
                                               th:href="${'/files/' + file.getId()}"
                                               th:text="${file.summary}"></a>
                                            <span th:if="${file.hasBeenAnalyzed()}" th:with="analysis=${file.analysis}">
                                                <span class="fa"
                                                      th:classappend="${analysis.authenticationStatusCssClass}"
                                                      th:text="' ' + ${analysis.authenticationStatus}"></span>
                                                <span class="fa fa-times text-danger"
                                                      th:if="${analysis.isInWrongCategory}"
                                                > Mauvaise catégorie</span>
                                                <br/>
                                                <span class="small" th:if="${analysis.isNotAuthenticated}">
                                                    <span class="bold">Devrait contenir : </span>
                                                    <span th:text="${analysis.authenticatedContent}"></span>
                                                </span>
                                            </span>
                                        </li>
                                    </ul>
                                    <div th:if="${document.documentAnalysisReport != null}"
                                         th:class="${'prevalidation-background-' + document.documentAnalysisReport.analysisStatus}"
                                    >
                                        <div th:replace="~{bo/fragments/document-analysis :: analysis(
                                            report=${document.documentAnalysisReport},
                                            documentRuleLevel=${documentRuleLevel},
                                            uid=${(document.id != null) ? 'doc-' + document.id : 'doc-' + iter.index}
                                          )}">
                                        </div>
                                    </div>
                                    <!-- contenu si le rapport n'existe pas (else) -->
                                    <div th:unless="${document.documentAnalysisReport != null}"
                                         th:class="${'prevalidation-background-UNDEFINED'}">
                                        <div class="mb-1">
                                            <span class="fw-semibold">Aucune analyse disponible</span>
                                        </div>
                                    </div>
                                    <div th:if="${document.avisDetected}">
                                        - Attention, un avis de situation a été détecté !
                                    </div>
                                </div>
                                <div class="modal" role="dialog" tabindex="-1"
                                     th:id="'deleteModal'+${document.getId()}">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content bg-info-subtle">
                                            <div class="modal-header" style="padding: 10px;">
                                                <h5 class="modal-title bold" style="width: 80%;float: left;">
                                                    Confirmation
                                                </h5>
                                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                        type="button"></button>
                                            </div>
                                            <div class="modal-body bg-body-tertiary"
                                                 style="text-shadow: 0 0 black;">
                                                <p>Êtes-vous sûr de vouloir supprimer ce document ?</p>
                                            </div>
                                            <div class="modal-footer bg-body-tertiary" style="padding: 5px;">
                                                <a class="btn btn-primary"
                                                   style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                   th:href="@{/bo/tenant/delete/document/} + ${document.getId()}"
                                                   th:id="'deleteRef' + ${document.getId()}">
                                                    Oui
                                                </a>
                                                <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                        style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                        type="button">
                                                    Annuler
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h3 th:unless="${tenant.getGuarantors().isEmpty()}">Garants</h3>
                        <div class="medium-space-separator" th:each="guarantor : ${tenant.getGuarantors()}">
                            <div>
                                <span th:text="${guarantor.getTypeGuarantor()}"></span>
                                <a class="btn btn-danger bo-btn btn-deleteGuarantor"
                                   style="margin-right: 10px; margin-left: 20px; margin-top: -5px"
                                   th:attr="guarantor-id=${guarantor.getId()}"
                                   th:text="'Supprimer le garant'"
                                ></a>
                            </div>
                            <div class="card panel-primary mb-3"
                                 th:each="document,iter : ${tenantService.getAllDocumentCategoriesGuarantor(guarantor)}">
                                <div class="card-header">
                                    <div class="card-title" th:if="${ document.getId() == null }">
                                        <span>Category:
                                            <span
                                                    th:text="${document.getDocumentCategory().name()}">
                                            </span>
                                        </span>
                                    </div>

                                    <div class="card-title"
                                         th:if="${document.getId() != null} and ${document.getWatermarkFile() == null}">
                                        <span>Category:
                                            <span
                                                    th:text="${document.getDocumentCategory().name()}">
                                            </span>
                                        </span>
                                        <span> Subcategory:
                                            <span
                                                    th:text="${document.getDocumentSubCategory().name()}">
                                            </span>
                                        </span>

                                        <a class="btn btn-sm btn-warning btn-right-pull pull-right deleteButton badge bg-warning text-dark"
                                           th:attrappend="data-id=${document.id}"

                                           th:href="@{/bo/tenant/delete/document/} + ${document.getId()}"
                                        >DELETE
                                        </a>

                                        <span class="btn-right-pull badge bg-success pull-right"
                                              style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='VALIDATED'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>
                                        <span class="btn-right-pull badge bg-danger pull-right" style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='DECLINED'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>
                                        <span class="btn-right-pull badge bg-info pull-right" style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='TO_PROCESS'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>

                                        <div class="container" style="margin-top: 5px; padding-left: 0">
                                            PDF status:
                                            <span th:if="${document.getLastModifiedDate() == null || document.getLastModifiedDate().plusMinutes(30).isBefore(now)}"
                                                  style="color:white; background-color: red; font-weight: bolder">
                                                    FAILED
                                            </span>
                                            <span th:unless="${document.getLastModifiedDate() == null || document.getLastModifiedDate().plusMinutes(30).isBefore(now)}"
                                                  style="color:white; background-color: orange; font-weight: bolder">
                                                    IN_PROGRESS
                                            </span>

                                            <a class="btn btn-secondary btn-sm ms-2"
                                               th:href="@{/bo/regeneratePdfDocument/} + ${document.getId()}">Update
                                                PDF</a>

                                        </div>
                                    </div>

                                    <div class="card-title"
                                         th:if="${ document.getId() != null} and ${document.getWatermarkFile() != null}">
                                        <span>Category:
                                            <span
                                                    th:text="${document.getDocumentCategory().name()}">
                                            </span>
                                        </span>
                                        <span> Subcategory:
                                            <span
                                                    th:text="${document.getDocumentSubCategory().name()}">
                                            </span>
                                        </span>

                                        <a class="btn btn-sm btn-warning btn-right-pull pull-right deleteButton badge bg-warning text-dark"
                                           th:attrappend="data-id=${document.id}"

                                           th:href="@{/bo/tenant/delete/document/} + ${document.getId()}"
                                        >DELETE
                                        </a>

                                        <span class="btn-right-pull badge bg-success pull-right"
                                              style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='VALIDATED'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>
                                        <span class="btn-right-pull badge bg-danger pull-right" style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='DECLINED'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>
                                        <span class="btn-right-pull badge bg-info pull-right" style="color: black;"
                                              th:if="${document.getDocumentStatus().name()=='TO_PROCESS'}"
                                              th:text="${document.getDocumentStatus()}">
                                        </span>

                                        <div class="container" style="display: flex; margin-top: 5px">
                                            <form method="get" style="margin-top: 8px;"
                                                  th:action="@{/bo/tenant/status/} + ${document.getId()}"
                                                  th:id="'form-change-document-status' + ${document.getId()}"
                                                  th:object="${messageDTO}">
                                                <label for="action1"
                                                       style="FONT-SIZE:revert;color: white;">Change status:</label>
                                                <select id="action1" name="action"
                                                        style="font-size: smaller;"
                                                        th:attr="document-id=${document.getId()}"
                                                        th:class="'select-change-document-status'"
                                                        th:field="*{message}">
                                                    <option value="">-- SELECT --</option>
                                                    <option th:value="DECLINED">DECLINED</option>
                                                    <option th:value="TO_PROCESS">TO_PROCESS</option>
                                                    <option th:value="VALIDATED">VALIDATED</option>
                                                </select>
                                            </form>

                                            <a class="btn btn-light btn-sm ms-2"
                                               th:href="@{/bo/regeneratePdfDocument/} + ${document.getId()}">Update
                                                Document PDF</a>

                                            <a class="btn btn-light btn-sm ms-2"
                                               th:href="${'/documents/'+ document.getName()}" target="_blank">See
                                                Document PDF</a>
                                        </div>
                                    </div>

                                </div>
                                <div class="card-body" style="text-align: -webkit-center;background: #f0be4e"
                                     th:if="${document.getId() == null}">
                                    <div style="font-weight: bold;">ABSENT</div>
                                </div>
                                <div class="card-body" th:if="${document.getId() != null}">
                                    <div th:if="${document.getMonthlySum()!=null}">
                                        <span th:text="${'Montly sum: '+document.getMonthlySum()}"></span>
                                    </div>
                                    <div th:if="${document.getCustomText()!=null}">
                                        <span th:text="${'Custom text: '+document.getCustomText()}"></span>
                                    </div>
                                    <ul>
                                        <li style="margin-top: 5px"
                                            th:each="file : ${filesByDocument.get(document.getId())}">
                                            <a target="_blank" rel="noopener"
                                               th:href="${'/files/' + file.getId()}"
                                               th:text="${file.summary}"></a>
                                            <span th:if="${file.hasBeenAnalyzed()}" th:with="analysis=${file.analysis}">
                                                <span class="fa"
                                                      th:classappend="${analysis.authenticationStatusCssClass}"
                                                      th:text="' ' + ${analysis.authenticationStatus}"></span>
                                                <span class="fa fa-times text-danger"
                                                      th:if="${analysis.isInWrongCategory}"
                                                > Mauvaise catégorie</span>
                                                <br/>
                                                <span class="small" th:if="${analysis.isNotAuthenticated}">
                                                    <span class="bold">Devrait contenir : </span>
                                                    <span th:text="${analysis.authenticatedContent}"></span>
                                                </span>
                                            </span>
                                        </li>
                                    </ul>
                                    <div th:if="${document.documentAnalysisReport != null}"
                                         th:class="${'prevalidation-background-' + document.documentAnalysisReport.analysisStatus}"
                                    >
                                        <div th:replace="~{bo/fragments/document-analysis :: analysis(
                                            report=${document.documentAnalysisReport},
                                            documentRuleLevel=${documentRuleLevel},
                                            uid=${(document.id != null) ? 'doc-' + document.id : 'doc-' + iter.index}
                                          )}">
                                        </div>
                                    </div>
                                    <!-- contenu si le rapport n'existe pas (else) -->
                                    <div th:unless="${document.documentAnalysisReport != null}"
                                         th:class="${'prevalidation-background-UNDEFINED'}">
                                        <div class="mb-1">
                                            <span class="fw-semibold">Aucune analyse disponible</span>
                                        </div>
                                    </div>
                                    <div th:if="${document.avisDetected}">
                                        - Attention, un avis de situation a été détecté !
                                    </div>
                                </div>
                                <div class="modal" role="dialog" tabindex="-1"
                                     th:id="'deleteModal'+${document.getId()}">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content bg-info-subtle">
                                            <div class="modal-header" style="padding: 10px;">
                                                <h5 class="modal-title bold" style="width: 80%;float: left;">Confirm
                                                    delete</h5>
                                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                        type="button"></button>
                                            </div>
                                            <div class="modal-body bg-body-tertiary"
                                                 style="text-shadow: 0 0 black;">
                                                <p>Are you sure you want delete this document ?</p>
                                            </div>
                                            <div class="modal-footer bg-body-tertiary" style="padding: 5px;">
                                                <a class="btn btn-primary"
                                                   style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                   th:href="@{/bo/tenant/delete/document/} + ${document.getId()}"
                                                   th:id="'deleteRef' + ${document.getId()}">Delete</a>
                                                <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                        style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                        type="button">
                                                    Close
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal" role="dialog" tabindex="-1"
                                     th:id="'modalDeleteGuarantor-'+${guarantor.getId()}">
                                    <div class="modal-dialog" role="guarantor">
                                        <div class="modal-content bg-info-subtle">
                                            <div class="modal-header" style="padding: 10px;">
                                                <h5 class="modal-title bold" style="width: 80%;float: left;">Confirm
                                                    delete</h5>
                                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                                        type="button"></button>
                                            </div>
                                            <div class="modal-body bg-body-tertiary"
                                                 style="text-shadow: 0 0 black;">
                                                <p>Are you sure you want delete this guarantor ?</p>
                                            </div>
                                            <div class="modal-footer bg-body-tertiary" style="padding: 5px;">
                                                <a class="btn btn-primary"
                                                   style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                   th:href="@{/bo/tenant/delete/guarantor/} + ${guarantor.getId()}">Delete</a>
                                                <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                        style="border-radius: 50px;font-size: 15px;line-height: 1;padding: 5px 8px 7px;"
                                                        type="button">
                                                    Close
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" role="tabpanel"
                     th:each="tenant,iter: ${tenants}" th:id="'tenant-message'+${tenant.id}">
                </div>
            </div>
        </div>

    </div>
</div>
</body>
</html>
