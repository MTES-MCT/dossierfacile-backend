<!-- templates/fragments/document-analysis.html -->
<div th:fragment="analysis(report, uid, label, documentRuleLevel)">
    <div th:if="${report != null}"
         th:with="
         status=${report.analysisStatus},
         passed=${report.getFilteredPassedRules(documentRuleLevel)},
         failed=${report.getFilteredFailedRules(documentRuleLevel)},
         inconclusive=${report.inconclusiveRules},
         theLabel=${label} ?: 'Statut de la vérification automatique :'
       "
         th:class="${'prevalidation-background-' + status}">

        <div class="mb-1">
            <span th:text="${theLabel}">Statut de la vérification automatique :</span>
            <span class="fw-semibold" th:text="${status}"></span>
        </div>

        <!-- Visibles selon le statut courant -->
        <div th:if="${status.name == 'DENIED'}" class="mb-2">
            <div class="fw-bold text-danger mb-1">FAILED rules</div>
            <ul class="small ps-3 mb-0" th:if="${!#lists.isEmpty(failed)}">
                <li th:each="r : ${failed}" th:text="${r.message}">Rule failed</li>
            </ul>
            <div class="small text-muted" th:if="${#lists.isEmpty(failed)}">None</div>
        </div>

        <div th:if="${status == 'INCONCLUSIVE'}" class="mb-2">
            <div class="fw-bold text-warning mb-1">Inconclusive rules</div>
            <ul class="small ps-3 mb-0" th:if="${inconclusive != null and !#lists.isEmpty(inconclusive)}">
                <li th:each="r : ${inconclusive}" th:text="${r.message}">Rule inconclusive</li>
            </ul>
            <div class="small text-muted" th:if="${inconclusive == null or #lists.isEmpty(inconclusive)}">None</div>
        </div>

        <!-- PASSED : rien par défaut -->

        <!-- Bouton Voir plus / Voir moins -->
        <button class="btn btn-sm btn-outline-secondary mt-1"
                type="button"
                data-bs-toggle="collapse"
                th:attr="data-bs-target=|#${uid}-rules-more|"
                th:aria-controls="|${uid}-rules-more|"
                th:if="${
                    (status.name == 'DENIED' and (!#lists.isEmpty(passed) or !#lists.isEmpty(inconclusive)))
                    or (status.name == 'UNDEFINED' and (!#lists.isEmpty(passed) or !#lists.isEmpty(failed) or !#lists.isEmpty(inconclusive)))
                    or (status.name == 'CHECKED' and (!#lists.isEmpty(passed) or !#lists.isEmpty(failed) or !#lists.isEmpty(inconclusive)))
                }"
                aria-expanded="false">
            <span class="label-collapsed">Voir plus</span>
            <span class="label-expanded">Voir moins</span>
        </button>
        <!-- Détail -->
        <div class="collapse mt-2 rules-more" th:id="|${uid}-rules-more|">

            <div th:if="${!#lists.isEmpty(passed)}">
                <div class="fw-bold text-success mb-1">PASSED rules</div>
                <ul class="small ps-3 mb-0">
                    <li th:each="r : ${passed}" th:text="${r.message}">Rule passed</li>
                </ul>
            </div>

            <div th:if="${status.name != 'DENIED' && !#lists.isEmpty(failed)}">
                <div class="fw-bold text-danger mb-1">FAILED rules</div>
                <ul class="small ps-3 mb-0">
                    <li th:each="r : ${failed}" th:text="${r.message}">Rule failed</li>
                </ul>
            </div>

            <div class="mt-3" th:if="${inconclusive != null && !#lists.isEmpty(inconclusive)}">
                <div class="fw-bold text-warning mb-1">Inconclusive rules</div>
                <ul class="small ps-3 mb-0">
                    <li th:each="r : ${inconclusive}" th:text="${r.message}">Rule inconclusive</li>
                </ul>
            </div>
        </div>
    </div>
</div>

